{% extends 'personel/base.html' %}

{% block title %}
Caraga State University Cabadbaran Campus(CSUCC)
{% endblock  %}

{% block content %}

<!-- #10420C -->
<!-- #FFCC00 -->
<!-- #bb2124 -->

<style>
/* Hide badge by default */
{% comment %} #notification-badge {
  display: none;
} {% endcomment %}

/* Swing like a real bell */
@keyframes swing-bell {
  0%   { transform: rotate(0deg); }
  10%  { transform: rotate(20deg); }
  20%  { transform: rotate(-18deg); }
  30%  { transform: rotate(16deg); }
  40%  { transform: rotate(-14deg); }
  50%  { transform: rotate(12deg); }
  60%  { transform: rotate(-10deg); }
  70%  { transform: rotate(8deg); }
  80%  { transform: rotate(-6deg); }
  90%  { transform: rotate(4deg); }
  100% { transform: rotate(0deg); }
}

.ringing {
  animation: swing-bell 1s ease-in-out;
  transform-origin: top center; /* pivot at the top like a real bell */
}

/* Pulse for notification badge */
@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.3); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}

#notification-badge.active {
  display: flex !important;
  animation: pulse 1s infinite;
}

/* Pagination styles */
.pagination-container {
  display: flex;
  justify-content: center;
  margin-top: auto; /* Push to bottom */
  padding: 10px 5px;
  background: white;

  bottom: 0;
  border-top: 1px solid #e0e0e0;
}

.pagination-btn {
  background-color: #10420C;
  color: white;
  border: none;
  padding: 5px 12px;
  margin: 0 5px;
  cursor: pointer;
  font-size: 14px;
}

.pagination-btn:hover:not(:disabled) {
  background-color: #10420C;
}

.pagination-btn:disabled {
  background-color: #cccccc;
  cursor: not-allowed;
}

.pagination-info {
  margin: 0 10px;
  padding: 5px 12px;
  font-size: 14px;
  display: flex;
  align-items: center;
}

/* Container styles for proper sticky footer */
.table-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 300px; /* Ensure minimum height */
}

.table-scroll {
  flex: 1;
  overflow-y: auto;
  max-height: 300px; /* Limit height and add scroll */
}

/* Fix overall layout height */
.main-content {
  display: flex;
  flex-direction: column;
  min-height: calc(100vh - 200px); /* Adjust based on header/footer height */
}

.content-section {
  flex: 1;
  display: flex;
  gap: 1rem;
  min-height: 0; /* Important for flex children to respect overflow */
}

/* Responsive adjustments */
@media (max-width: 1024px) {
  .content-section {
    flex-direction: column;
  }
  
  .left-panel, .right-panel {
    width: 100%;
    max-width: 100%;
  }
}

/* Ensure tables don't overflow */
table {
  width: 100%;
  table-layout: fixed;
}

th, td {
  word-wrap: break-word;
  overflow: hidden;
  text-overflow: ellipsis;
}
</style>
{% load static %}
<div class="flex mt-7 justify-between">
    <div class="flex gap-4 md:gap-10">
       <div class="relative">
            <a href="#" class="text-sm border-b-3 border-[#10420C]">Dashboard</a>
           

            <!-- Bell container -->
            <div class="absolute left-18 top-0">  
                <div class="relative">
                    <i id="bell-icon" class="fa fa-bell text-2xl cursor-pointer text-gray-700"></i>
                    <span id="notification-badge"
                        class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold w-4 h-4 flex items-center justify-center rounded-full hidden">
                    </span>
                </div>
            </div>
        </div>

        
    </div>

    <div class="flex gap-4">
        <form action="{% url 'auth_logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="cursor-pointer hover:text-red-500">Logout</button>
        </form>

        <button class="bg-[#bb2124] hover:bg-[#bb2124]/80 cursor-pointer text-sm text-white px-6 md:px-10 py-1"
                type="button"
                 onclick="document.getElementById('endAllModal').classList.remove('hidden')" >
                END ALL
        </button>

        <!-- Confirmation Modal -->
        <div id="endAllModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
            <div class="bg-white shadow-lg p-6 w-full max-w-md mx-4">
                <h2 class="text-lg font-semibold text-gray-800">Confirm Action</h2>
                <p class="mt-2 text-gray-600">Are you sure you want to <b>cancel all</b> pending and skipped appointments?</p>
                
                <div class="mt-6 flex justify-end gap-3">
                    <!-- Cancel Button -->
                    <button 
                        class="px-4 py-2 text-sm bg-gray-300 hover:bg-gray-400 cursor-pointer"
                        onclick="document.getElementById('endAllModal').classList.add('hidden')">
                        No, Keep
                    </button>

                    <!-- Confirm Form -->
                    <form method="post" action="{% url 'end_all_appointments' %}">
                        {% csrf_token %}
                        <button type="submit" 
                            class="px-4 py-2 text-sm bg-[#bb2124] cursor-pointer text-white hover:bg-[#bb2124]/80">
                            Yes, End All
                        </button>
                    </form>
                </div>
            </div>
        </div>

        
    </div>
</div>

<section id="student" class="flex flex-col lg:flex-row mt-6 gap-6 min-h-[700px] ">
   
    <!-- left -->
    <div class="flex flex-col bg-white py-4 px-4 w-full lg:max-w-md text-center shadow-[0_4px_10px_rgba(0,0,0,0.6)] ">
        <audio id="bell-sound" src="{% static 'sound/bell-ring.mp3' %}" preload="auto"></audio>

        <!-- current -->
        <h2 class="text-gray-700 text-sm font-semibold ">
                    Current Serving Number
        </h2>
        {% if get_current_number %}
            <div class="min-h-[200px] flex justify-center items-center py-4">

                <div class="flex items-center "> 
                    <p class="text-[#10420C] text-7xl md:text-8xl medula-one-regular">
                    {{ get_current_number.ticket_number }}
                    </p>
                </div>
            </div>
        {% else %}
            <div class="min-h-[200px] flex flex-col justify-center items-center py-4">
                <div class="flex flex-col items-center gap-4 ">
                    <p class="text-gray-500 text-sm ">
                    No request appointment now
                    </p>
                    <form action="{% url 'personel' %}" method="POST">
                        {% csrf_token %}
                        <button class="bg-[#10420C] hover:bg-[#10420C]/80 text-sm text-white px-8 py-2 cursor-pointer"
                            type="submit" name="start" value="start">
                            Start
                        </button>
                    </form>
                </div>
            </div>
        {% endif %}        

        <div class="border-1 border-gray-400 my-4"></div>

        <div class="flex-col table-container">
            <h1 class="text-center px-4 py-2 text-base font-bold text-white bg-[#10420C]">Waiting List</h1>

            <div class="table-scroll">
                <table class="w-full">
                    <thead class="text-base">
                        <tr>
                            <th class="text-left px-4 py-1 w-1/2">Number</th>
                            <th class="text-center px-4 py-1 w-1/2">User</th>
                        </tr>
                    </thead>
                    <tbody id="wait-body">
                        {% for display_queue in display_queues  %}
                        <tr class="{% if display_queue.status == 'standby' and display_queue.is_priority == 'no'  %} bg-[#FFCC00]/20 
                                                    {% elif display_queue.status == 'standby' and display_queue.is_priority == 'yes'  %} bg-[#ED7676]/20
                                                    {% else %}bg-[#10420C]/20
                                                    {% endif %} ">
                            <td class="text-left px-4 py-2 text-sm ">{{ display_queue.ticket_number }}</td>
                            <td class="px-4 py-2 text-sm text-center">{{ display_queue.user_type }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="pagination-container" id="wait-pagination">
                <button class="pagination-btn" id="wait-prev-btn" disabled>Prev</button>
                <span class="pagination-info" id="wait-page-info">Page 1</span>
                <button class="pagination-btn" id="wait-next-btn">Next</button>
            </div>
        </div>
    </div>

    <!-- right  -->
    <div class="flex-1 flex flex-col min-h-0">
        <div class="bg-white shadow-[0_4px_10px_rgba(0,0,0,0.6)] min-h-[250px]">
            <div class="bg-[#10420C] text-white text-base p-2 text-center">
                <h2 class="text-base font-bold" >INFORMATION</h2>
            </div>
            <div class="mx-4 overflow-x-auto flex ">
                <table class="w-full border-collapse mt-8 min-w-full">
                    <thead class="text-base">
                        <tr class="border-b border-[#DEDEDE]">
                            <th class="text-center px-4 py-2 w-1/5">Full Name</th>
                            <th class="text-center px-4 py-2 w-1/5">Course</th>
                            <th class="text-center px-4 py-2 w-1/5">Request</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        {% if get_current_number %}
                        <tr>
                            <td class="px-4 py-2  text-center">{{ get_current_number.firstName }} {{ get_current_number.middleName }}. {{ get_current_number.lastName }}</td>
                            <td class="px-4 py-2  text-center">{{ get_current_number.courses }}</td>
                            <td class="px-4 py-2 text-center">
                                {% if get_current_number.requestType == None %}
                                    {{ get_current_number.custom_request }}
                                {% else %}
                                    {{ get_current_number.requestType }}
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td class="px-4 py-2 text-center " colspan="4">NO REQUEST RIGHT NOW</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="flex justify-center my-4 px-4 text-sm">
                <form action="{% url 'done_current_number' %}" method="post" class="w-full">
                    {% csrf_token %}
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        {% if get_current_number %}
                            <input type="hidden" name="ticket_number" value="{{ get_current_number.id }}" >
                            <button type="submit" name="action" value="done"
                                class="bg-[#10420C] hover:bg-[#10420C]/80 text-white px-6 py-2 cursor-pointer w-full sm:w-auto" >
                            Done</button>
                            <button type="submit" name="action" value="skip"
                            class="bg-[#FFCC00] hover:bg-[#FFCC00]/80 text-black px-6 py-2 cursor-pointer w-full sm:w-auto" >Skip</button>
                            <!-- call  -->
                            <button onclick="speakNumber('{{ get_current_number.ticket_number }}', '{{ get_current_number.firstName }} {{ get_current_number.lastName }}')"
                                type="button"
                                class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 cursor-pointer w-full sm:w-auto">
                                Call
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>  
        
        <!-- skip and priority -->
        <div class="mt-6 flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
            <!-- Skipped List -->
            <div class="flex-1 bg-white flex flex-col shadow-[0_4px_10px_rgba(0,0,0,0.6)] table-container min-h-0"> 
                <div class="bg-[#FFCC00] text-black p-2 text-center">
                    <h2 class="font-semibold tracking-wide">SKIPPED LIST</h2>
                </div>

                <div class="table-scroll">
                    <table class="w-full">
                        <thead class="text-base">
                            <tr>
                                <th class="text-left px-4 py-2 w-2/5">Full Name</th>
                                <th class="text-left px-4 py-2 w-1/5">Number</th>
                                <th class="text-center px-4 py-2 w-2/5">Action</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm" id="skip-body">
                            {% if skip_non_priority_students %}
                                {% for skip_non_priority_student in skip_non_priority_students %}
                                    <tr>
                                        <td class="px-4 py-2">{{ skip_non_priority_student.firstName }} {{ skip_non_priority_student.middleName }}. {{ skip_non_priority_student.lastName }}</td>
                                        <td class="px-4 py-2">{{ skip_non_priority_student.ticket_number }}</td>
                                        <td class="px-4 py-2">
                                            <form action="{% url 'standby' %}" method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="ticket_number" value="{{skip_non_priority_student.id}}">
                                                <button type="submit" name="action" value="standby"
                                                    class="bg-[#FFCC00] hover:bg-[#FFCC00]/80 p-1 cursor-pointer w-full">
                                                    Standby
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}     
                                    <tr>
                                        <td colspan="3" class="text-center px-4 py-2">No Skipped Right Now</td>
                                    </tr>
                            {% endif %}   
                        </tbody>
                    </table>
                </div>

                <div class="pagination-container" id="skip-pagination">
                    <button class="pagination-btn" id="skip-prev-btn" disabled>Prev</button>
                    <span class="pagination-info" id="skip-page-info">Page 1</span>
                    <button class="pagination-btn" id="skip-next-btn">Next</button>
                </div>
            </div>

            <!-- Priority List -->
            <div class="flex-1 bg-white flex flex-col shadow-[0_4px_10px_rgba(0,0,0,0.6)] table-container min-h-0"> 
                <div class="bg-[#ED7676] text-white p-2 text-center">
                    <h2 class="font-semibold tracking-wide">PRIORITY QUEUE'S</h2>
                </div>

                <div class="table-scroll">
                    <table class="w-full">
                        <thead class="text-base">
                            <tr>
                                <th class="text-left px-4 py-2 w-2/5">Full Name</th>
                                <th class="text-left px-4 py-2 w-1/5">Number</th>
                                <th class="text-center px-4 py-2 w-2/5">Action</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm" id="priority-body">
                            {% if priority_students %}
                                {% for priority_student in priority_students %}
                                    <tr>
                                        <td class="px-4 py-2">{{ priority_student.firstName }} {{ priority_student.middleName }} {{ priority_student.lastName }}</td>
                                        <td class="px-4 py-2">{{ priority_student.ticket_number }}</td>
                                        <td class="px-4 py-2">
                                            <form action="{% url 'priority_standby' %}" method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="ticket_number" value="{{priority_student.id}}">
                                                <button type="submit" name="action" value="standby"
                                                    class="bg-[#FFCC00] hover:bg-[#FFCC00]/80 p-1 cursor-pointer w-full">
                                                    Standby
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}    
                            {% else %}
                                <tr>
                                    <td class="px-4 py-2 text-center" colspan="3">No Pending Right Now</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination-container" id="priority-pagination">
                    <button class="pagination-btn" id="priority-prev-btn" disabled>Prev</button>
                    <span class="pagination-info" id="priority-page-info">Page 1</span>
                    <button class="pagination-btn" id="priority-next-btn">Next</button>
                </div>
            </div>
        </div>
    </div>

</section>    

<section class="p-6 bg-white mt-8 shadow-[0_4px_10px_rgba(0,0,0,0.6)]">
  <h1 class="text-2xl font-bold mb-6">Client Satisfaction Survey</h1>

  <div class="flex gap-6 justify-between ">
    <!-- First table -->
    <div class="bg-white shadow-[0_4px_10px_rgba(0,0,0,0.6)]">
      <table class="min-w-full border border-gray-300 rounded-lg">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 border">Question</th>
            <th class="px-4 py-2 border">Answer</th>
            <th class="px-4 py-2 border">Answer</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="px-4 py-2 border">Service Quality</td>
            <td class="px-4 py-2 border">Excellent</td>
            <td class="px-4 py-2 border">Excellent</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Second table -->
    <div class="bg-white shadow-[0_4px_10px_rgba(0,0,0,0.6)]">
      <table class="min-w-full border border-gray-300 rounded-lg">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 border">Aspect</th>
            <th class="px-4 py-2 border">Rating</th>
            <th class="px-4 py-2 border">Rating</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="px-4 py-2 border">Staff</td>
            <td class="px-4 py-2 border">Good</td>
            <td class="px-4 py-2 border">Good</td>
          </tr>
        </tbody>
      </table>
    </div>

    
  </div>
</section>





<script>
// Pagination function for all three tables
function setupPagination(tableId, prevBtnId, nextBtnId, pageInfoId, rowsPerPage = 5) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const rows = Array.from(table.getElementsByTagName('tr'));
    const prevBtn = document.getElementById(prevBtnId);
    const nextBtn = document.getElementById(nextBtnId);
    const pageInfo = document.getElementById(pageInfoId);
    
    let currentPage = 1;
    const totalPages = Math.max(Math.ceil(rows.length / rowsPerPage), 1);
    
    function showPage(page) {
        // Hide all rows
        rows.forEach(row => row.style.display = 'none');
        
        // Show rows for current page
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        
        for (let i = start; i < end && i < rows.length; i++) {
            rows[i].style.display = '';
        }
        
        // Update buttons
        if (prevBtn) prevBtn.disabled = (page === 1);
        if (nextBtn) nextBtn.disabled = (page === totalPages);
        
        // Update page info
        if (pageInfo) pageInfo.textContent = ` ${page} : ${totalPages}`;
    }
    
    // Event listeners
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage);
            }
        });
    }
    
    // Initialize
    showPage(1);
}

// Initialize pagination for all three tables when page loads
document.addEventListener('DOMContentLoaded', function() {
    setupPagination('wait-body', 'wait-prev-btn', 'wait-next-btn', 'wait-page-info');
    setupPagination('skip-body', 'skip-prev-btn', 'skip-next-btn', 'skip-page-info');
    setupPagination('priority-body', 'priority-prev-btn', 'priority-next-btn', 'priority-page-info');
});
    
function speakNumber(ticketNumber, fullname) {
    // Stop ongoing speech
    window.speechSynthesis.cancel();

    const text = `Calling ${ticketNumber}, ${fullname}. Please come to the window.`;
    const message = new SpeechSynthesisUtterance(text);

    message.lang = "en-US";
    message.rate = 0.8;   // normal speaking speed
    message.pitch = 1.5; // slightly higher pitch → more feminine
    message.volume = 1;

    let voices = speechSynthesis.getVoices();

    if (voices.length === 0) {
        speechSynthesis.onvoiceschanged = () => {
            voices = speechSynthesis.getVoices();
            setFemaleVoice(message, voices);
            speechSynthesis.speak(message);
        };
    } else {
        setFemaleVoice(message, voices);
        speechSynthesis.speak(message);
    }
}

function setFemaleVoice(message, voices) {
    // Pick Microsoft Zira if available
    const preferred = voices.find(v => v.name.includes("Zira"))
        || voices.find(v => v.name.includes("Female")) // fallback (if other browsers use "Female" in name)
        || voices[0]; // last fallback: first available

    if (preferred) {
        message.voice = preferred;
        console.log("Selected voice:", preferred.name);
    }
}

const socket = new WebSocket("ws://" + window.location.host + "/ws/queue/");
const notificationCountEl = document.getElementById("notification-count");

function playBell() {
    const bellSound = document.getElementById("bell-sound");
    bellSound.src = bellSound.src.split("?")[0] + "?v=" + new Date().getTime(); 
    bellSound.load();
    bellSound.play().catch(e => console.log("Autoplay blocked:", e));

}


let pendingCount = 0;
let lastPendingCount = 0;
socket.onmessage = function (event) {
    const data = JSON.parse(event.data);

    if (data.stats) {
        const totalPending = data.stats.non_priority_count + data.stats.priority_count;
        const bellIcon = document.getElementById("bell-icon");
        const badge = document.getElementById("notification-badge");
        const bellSound = document.getElementById("bell-sound");

        if (totalPending > 0) {
            badge.textContent = totalPending;
            badge.classList.add("active");

            bellIcon.classList.add("ringing");
            playBell();


            setTimeout(() => {
                bellIcon.classList.remove("ringing");
            }, 1200);
        } else {
            badge.classList.remove("active");
            badge.style.display = "none";
        }

        // ✅ Render waiting list table
        if (data.waiting_list) {
            const tbody = document.getElementById("wait-body");
            tbody.innerHTML = ""; // clear table

            data.waiting_list.forEach(item => {
                let rowClass = "";
                if (item.status === "standby" && item.is_priority === "no") {
                    rowClass = "bg-[#FFCC00]/20";
                } else if (item.status === "standby" && item.is_priority === "yes") {
                    rowClass = "bg-[#ED7676]/20";
                } else {
                    rowClass = "bg-[#10420C]/20";
                }

                const row = `
                    <tr class="${rowClass}">
                        <td class="text-left px-4 py-2 text-sm">${item.ticket_number}</td>
                        <td class="px-4 py-2 text-sm text-center">${item.user_type}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML("beforeend", row);
            });
        }
    }
};


function updateNotification() {
    if (pendingCount > 0) {
        notificationCountEl.textContent = pendingCount;
        notificationCountEl.classList.remove("hidden");
    } else {
        notificationCountEl.classList.add("hidden");
    }
}

    setInterval(() => {
    const bellSound = document.getElementById("bell-sound");
    console.log(bellSound);
    bellSound.load(); // reloads audio into memory
}, 5 * 60 * 1000); // every 5 minutes
</script>

{% endblock  %}
{% extends 'dashboard/base.html' %}

{% block title %}
Question Management
{% endblock %}

{% block content %}
{% load static %}

<div class="min-h-screen bg-gray-50/50 px-4 py-6 sm:px-6 lg:px-8">
  <!-- HEADER -->
  <div class="mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div class="mb-4 sm:mb-0">
        <h1 class="text-xl font-bold text-gray-900 tracking-tight">Citizen's Charter (CC) Management</h1>
        <p class="text-[11px] text-gray-600 mt-2">Create and organize survey questions for different years</p>
      </div>
      <button id="openCreateModalBtn"
        class="inline-flex items-center gap-2 bg-[#10420C] text-white text-[11px] font-semibold px-5 py-3 hover:bg-[#10420C]/80 transition-all duration-200 cursor-pointer group">
        <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Create Question
      </button>
    </div>
  </div>

  <!-- QUESTIONS GRID -->
  <div class="overflow-hidden mt-3">
    <div class="px-6">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">Survey Questions</h2>
        <span class="inline-flex items-center gap-2 bg-gray-100 text-gray-700 text-lg font-medium px-3 py-1">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          {{ questions|length }} items
        </span>
      </div>
    </div>

    <div class="p-6">
      {% if questions %}
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        {% for question in questions %}
        <div class="group bg-white border border-gray-200 p-6 hover:border-[#10420C]/40 hover:shadow-md transition-all duration-300">
          <!-- Question Header -->
          <div class="flex items-start justify-between mb-4">
            <div class="flex flex-col gap-2">
                <h3 class="text-sm font-semibold text-gray-900 leading-tight pr-2">{{ question.name }}</h3>
                <div class="flex gap-2">
                    {% for year_link in question.year_links.all %}
                        <span class="inline-flex items-center text-[11px] font-medium text-green-700">
                        {{ year_link.year.year }}
                        </span>
                        {% empty %}
                        <span class="text-[11px] text-gray-400 italic">Not assigned to any year</span>
                    {% endfor %}
                </div>
            </div>
            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <button onclick="openEditModal({{ question.id }}, '{{ question.name|escapejs }}', {{ question.choices_list|safe }})"
                 class="p-1.5 text-black hover:text-[#10420C] hover:bg-[#10420C]/5 transition-colors cursor-pointer"
                 title="Edit question">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              <button onclick="openDeleteModal({{ question.id }}, '{{ question.name|escapejs }}')"
                 class="p-1.5 text-black hover:text-red-600 hover:bg-red-50 transition-colors cursor-pointer"
                 title="Delete question">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Choices with Show More -->
          <div class="mb-4">
            <p class="text-[11px] font-medium text-gray-500 uppercase tracking-wide mb-2">Choices</p>
            <div class="choices-container" data-question-id="{{ question.id }}">
              <div class="visible-choices flex flex-wrap gap-1.5">
                {% for choice in question.choices.all %}
                  {% if forloop.counter <= 2 %}
                  <span class="inline-flex items-center px-2.5 py-1 text-[11px] font-medium bg-blue-50 text-blue-700 border border-blue-200">
                    {{ choice.name }}
                  </span>
                  {% endif %}
                {% endfor %}
                
                {% if question.choices.all.count > 2 %}
                <button type="button" 
                        class="show-more-btn inline-flex items-center px-2.5 py-1 text-[10px] font-medium bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200 cursor-pointer transition-colors"
                        data-question-id="{{ question.id }}">
                  +{{ question.choices.all.count|add:"-2" }} more
                </button>
                {% endif %}
              </div>
              
              <div class="all-choices hidden flex-wrap gap-1.5 mt-2">
                {% for choice in question.choices.all %}
                <span class="inline-flex items-center px-2.5 py-1 text-[11px] font-medium bg-blue-50 text-blue-700 border border-blue-200">
                  {{ choice.name }}
                </span>
                {% endfor %}
                
                {% if question.choices.all.count > 2 %}
                <button type="button" 
                        class="show-less-btn inline-flex items-center px-2.5 py-1 text-[10px] font-medium bg-gray-100 text-gray-600 border border-gray-300 hover:bg-gray-200 cursor-pointer transition-colors ml-2">
                  Show less
                </button>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Assign to Year Form -->
          <div class="pt-4 border-t border-gray-200">
            <form method="POST" action="{% url 'assign_question_to_year' %}" class="flex gap-2">
              {% csrf_token %}
              <input type="hidden" name="question_id" value="{{ question.id }}">
              <select name="year_id" 
                      class="flex-1 text-sm border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#10420C] focus:border-[#10420C]">
                <option value="" disabled selected>Select year...</option>
                {% for year in available_years %}
                <option value="{{ year.id }}">{{ year.year }}</option>
                {% endfor %}
              </select>
              <button type="submit" 
                      class="bg-[#10420C] text-white text-sm px-4 py-2 hover:bg-[#10420C]/80 cursor-pointer transition-colors">
                Assign
              </button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <!-- Empty State -->
      <div class="text-center py-12">
        <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 flex items-center justify-center">
          <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h3 class="text-sm font-semibold text-gray-900 mb-2">No questions yet</h3>
        <p class="text-[11px] text-gray-500 mb-6 max-w-sm mx-auto">Get started by creating your first survey question to organize your feedback collection.</p>
        <button id="openCreateModalBtnEmpty"
          class="inline-flex items-center gap-2 bg-[#10420C] text-white text-[11px] font-semibold px-6 py-3 hover:bg-[#0a2f0a] transition-colors cursor-pointer">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Create First Question
        </button>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- CREATE MODAL -->
<div id="createModal" class="fixed inset-0 bg-black/50 hidden z-50 p-4">
  <div class="flex items-center justify-center min-h-full">
    <div class="bg-white shadow-xl w-full max-w-2xl transform transition-all">
      <!-- Modal Header -->
      <div class="px-8 py-6 border-b border-gray-200 bg-[#10420C]">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-white">Create New Question</h2>
          <button id="closeCreateModalBtn" class="text-white/80 hover:text-white text-2xl leading-none cursor-pointer transition-colors">&times;</button>
        </div>
      </div>

      <!-- Modal Form -->
      <form method="POST" action="{% url 'create_question' %}" class="p-8 space-y-8">
        {% csrf_token %}
        <div>
          <label class="block text-lg font-medium text-gray-900 mb-4">
            Question Text
            <span class="text-red-500 ml-1">*</span>
          </label>
          <input type="text" name="question_text"
            class="w-full border border-gray-300 px-6 py-4 text-base focus:outline-none focus:ring-2 focus:ring-[#10420C] focus:border-[#10420C] transition-all"
            placeholder="e.g., How satisfied are you with our service quality?"
            required>
        </div>

        <div>
          <label class="block text-lg font-medium text-gray-900 mb-4">
            Answer Choices
            <span class="text-gray-600 text-base font-normal ml-2">(one per line)</span>
          </label>
          <textarea name="choices_text" rows="6"
            class="w-full border border-gray-300 px-6 py-4 text-base focus:outline-none focus:ring-2 focus:ring-[#10420C] focus:border-[#10420C] resize-none transition-all"
            placeholder="Excellent&#10;Good&#10;Fair&#10;Poor"></textarea>
          <p class="text-base text-gray-600 mt-3">Each line will become a separate choice option</p>
        </div>

        <div class="flex justify-end gap-4 pt-6">
          <button type="button" id="cancelCreateModalBtn"
            class="px-8 py-3 text-base font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 cursor-pointer transition-colors">
            Cancel
          </button>
          <button type="submit"
            class="px-8 py-3 text-base font-semibold text-white bg-[#10420C] hover:bg-[#10420C]/80 cursor-pointer transition-all">
            Create Question
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="fixed inset-0 bg-black/50 hidden z-50 p-4">
  <div class="flex items-center justify-center min-h-full">
    <div class="bg-white shadow-xl w-full max-w-2xl transform transition-all">
      <!-- Modal Header -->
      <div class="px-8 py-6 border-b border-gray-200 bg-[#10420C]">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-white">Edit Question</h2>
          <button id="closeEditModalBtn" class="text-white/80 hover:text-white text-2xl leading-none cursor-pointer transition-colors">&times;</button>
        </div>
      </div>

      <!-- Modal Form -->
      <form id="editForm" method="POST" class="p-8 space-y-8">
        {% csrf_token %}
        <input type="hidden" name="question_id" id="editQuestionId">
        
        <div>
          <label class="block text-lg font-medium text-gray-900 mb-4">
            Question Text
            <span class="text-red-500 ml-1">*</span>
          </label>
          <input type="text" name="question_text" id="editQuestionText"
            class="w-full border border-gray-300 px-6 py-4 text-base focus:outline-none focus:ring-2 focus:ring-[#10420C] focus:border-[#10420C] transition-all"
            placeholder="e.g., How satisfied are you with our service quality?"
            required>
        </div>

        <div>
          <div class="flex items-center justify-between mb-4">
            <label class="block text-lg font-medium text-gray-900">
              Answer Choices
            </label>
            <button type="button" id="addChoiceBtn" 
                    class="inline-flex items-center gap-2 bg-[#10420C] text-white text-sm font-medium px-4 py-2 hover:bg-[#10420C]/80 cursor-pointer transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Add Choice
            </button>
          </div>
          
          <!-- Dynamic Choices Container -->
          <div id="choicesContainer" class="space-y-3 max-h-96 overflow-y-auto p-4  rounded-lg ">
            <!-- Choices will be dynamically added here -->
            <div class="text-center text-gray-500 py-8" id="noChoicesMessage">
              No choices added yet. Click "Add Choice" to start.
            </div>
          </div>

          <!-- Hidden textarea for form submission -->
          <textarea name="choices_text" id="editChoicesText" class="hidden"></textarea>
          
          <p class="text-base text-gray-600 mt-3">Edit choices individually above. Each input field represents one choice.</p>
        </div>

        <div class="flex justify-end gap-4 pt-6">
          <button type="button" id="cancelEditModalBtn"
            class="px-8 py-3 text-base font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 cursor-pointer transition-colors">
            Cancel
          </button>
          <button type="submit"
            class="px-8 py-3 text-base font-semibold text-white bg-[#10420C] hover:bg-[#10420C]/80 cursor-pointer transition-all">
            Update Question
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- DELETE CONFIRMATION MODAL -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 hidden z-50 p-4">
  <div class="flex items-center justify-center min-h-full">
    <div class="bg-white shadow-xl w-full max-w-md transform transition-all">
      <!-- Modal Header -->
      <div class="px-8 py-6 border-b border-gray-200 bg-red-500">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-white">Delete Question</h2>
          <button id="closeDeleteModalBtn" class="text-white/80 hover:text-white text-2xl leading-none cursor-pointer transition-colors">&times;</button>
        </div>
      </div>

      <!-- Modal Content -->
      <div class="p-8 space-y-6">
        <div class="flex items-center gap-4">
          <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Confirm Deletion</h3>
            <p class="text-sm text-gray-600 mt-1">Are you sure you want to delete this question? This action cannot be undone.</p>
          </div>
        </div>

        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h4 class="text-sm font-semibold text-red-800 mb-2">Question to be deleted:</h4>
          <p class="text-sm text-red-700 font-medium" id="deleteQuestionText"></p>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div>
              <p class="text-sm text-yellow-800 font-medium">Warning</p>
              <p class="text-xs text-yellow-700 mt-1">This will also delete all associated choices and remove this question from any assigned years.</p>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-4 pt-4">
          <button type="button" id="cancelDeleteModalBtn"
            class="px-6 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 cursor-pointer transition-colors">
            Cancel
          </button>
          <form id="deleteForm" method="POST" class="inline">
            {% csrf_token %}
            <button type="submit"
              class="px-6 py-3 text-sm font-semibold text-white bg-red-500 hover:bg-red-500/80 cursor-pointer transition-colors">
              Delete Question
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Choice Item Template -->
<template id="choiceTemplate">
  <div class="choice-item flex items-center gap-3 p-3 bg-white border border-gray-300 rounded-lg hover:border-[#10420C] transition-all duration-200 group">
    <span class="text-gray-500 text-sm font-medium choice-number"></span>
    <input type="text" 
           class="flex-1 border-none bg-transparent px-3 py-2 text-base focus:outline-none focus:ring-2 focus:ring-[#10420C] focus:bg-white rounded transition-all"
           placeholder="Enter choice text...">
    <button type="button" 
            class="remove-choice text-gray-400 hover:text-red-600 p-2 transition-colors cursor-pointer"
            title="Remove choice">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
      </svg>
    </button>
  </div>
</template>

<!-- SCRIPT -->
<script>
  // Create Modal Functionality
  const openCreateModalBtn = document.getElementById("openCreateModalBtn");
  const openCreateModalBtnEmpty = document.getElementById("openCreateModalBtnEmpty");
  const closeCreateModalBtn = document.getElementById("closeCreateModalBtn");
  const cancelCreateModalBtn = document.getElementById("cancelCreateModalBtn");
  const createModal = document.getElementById("createModal");

  function openCreateModal() {
    createModal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeCreateModal() {
    createModal.classList.add("hidden");
    document.body.style.overflow = "auto";
  }

  openCreateModalBtn?.addEventListener("click", openCreateModal);
  openCreateModalBtnEmpty?.addEventListener("click", openCreateModal);
  closeCreateModalBtn?.addEventListener("click", closeCreateModal);
  cancelCreateModalBtn?.addEventListener("click", closeCreateModal);

  // Edit Modal Functionality
  const closeEditModalBtn = document.getElementById("closeEditModalBtn");
  const cancelEditModalBtn = document.getElementById("cancelEditModalBtn");
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const choicesContainer = document.getElementById("choicesContainer");
  const addChoiceBtn = document.getElementById("addChoiceBtn");
  const editChoicesText = document.getElementById("editChoicesText");
  const choiceTemplate = document.getElementById("choiceTemplate");
  const noChoicesMessage = document.getElementById("noChoicesMessage");

  function openEditModal(questionId, questionText, choicesArray) {
    document.getElementById('editQuestionId').value = questionId;
    document.getElementById('editQuestionText').value = questionText;
    
    // Clear existing choices
    choicesContainer.innerHTML = '';
    
    // Add choices from array
    if (Array.isArray(choicesArray) && choicesArray.length > 0) {
      choicesArray.forEach((choice, index) => {
        addChoice(choice, index + 1);
      });
      noChoicesMessage.style.display = 'none';
    } else {
      // Show no choices message
      noChoicesMessage.style.display = 'block';
    }
    
    // Update hidden textarea
    updateHiddenTextarea();
    
    // Set form action
    editForm.action = `/dashboard/questions/${questionId}/edit/`;
    
    editModal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeEditModal() {
    editModal.classList.add("hidden");
    document.body.style.overflow = "auto";
  }

  function addChoice(text = '', number = null) {
    const choiceClone = choiceTemplate.content.cloneNode(true);
    const choiceItem = choiceClone.querySelector('.choice-item');
    const choiceInput = choiceClone.querySelector('input');
    const choiceNumber = choiceClone.querySelector('.choice-number');
    const removeBtn = choiceClone.querySelector('.remove-choice');
    
    // Set choice number
    const choiceCount = choicesContainer.querySelectorAll('.choice-item').length + 1;
    choiceNumber.textContent = number ? number : choiceCount + '.';
    
    // Set choice text
    if (text) {
      choiceInput.value = text;
    }
    
    // Add event listeners
    choiceInput.addEventListener('input', updateHiddenTextarea);
    removeBtn.addEventListener('click', function() {
      choiceItem.remove();
      updateChoiceNumbers();
      updateHiddenTextarea();
      checkEmptyChoices();
    });
    
    // Hide no choices message
    noChoicesMessage.style.display = 'none';
    
    choicesContainer.appendChild(choiceClone);
    updateHiddenTextarea();
  }

  function updateChoiceNumbers() {
    const choiceItems = choicesContainer.querySelectorAll('.choice-item');
    choiceItems.forEach((item, index) => {
      const numberElement = item.querySelector('.choice-number');
      numberElement.textContent = (index + 1) + '.';
    });
  }

  function updateHiddenTextarea() {
    const choiceInputs = choicesContainer.querySelectorAll('input[type="text"]');
    const choices = Array.from(choiceInputs)
      .map(input => input.value.trim())
      .filter(choice => choice !== '');
    
    editChoicesText.value = choices.join('\n');
  }

  function checkEmptyChoices() {
    const choiceItems = choicesContainer.querySelectorAll('.choice-item');
    if (choiceItems.length === 0) {
      noChoicesMessage.style.display = 'block';
    } else {
      noChoicesMessage.style.display = 'none';
    }
  }

  // Delete Modal Functionality
  const closeDeleteModalBtn = document.getElementById("closeDeleteModalBtn");
  const cancelDeleteModalBtn = document.getElementById("cancelDeleteModalBtn");
  const deleteModal = document.getElementById("deleteModal");
  const deleteForm = document.getElementById("deleteForm");
  const deleteQuestionText = document.getElementById("deleteQuestionText");

  function openDeleteModal(questionId, questionText) {
    // Set the question text in the modal
    deleteQuestionText.textContent = questionText;
    
    // Set the form action
    deleteForm.action = `/dashboard/questions/${questionId}/delete/`;
    
    deleteModal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeDeleteModal() {
    deleteModal.classList.add("hidden");
    document.body.style.overflow = "auto";
  }

  // Event Listeners
  closeEditModalBtn?.addEventListener("click", closeEditModal);
  cancelEditModalBtn?.addEventListener("click", closeEditModal);
  
  closeDeleteModalBtn?.addEventListener("click", closeDeleteModal);
  cancelDeleteModalBtn?.addEventListener("click", closeDeleteModal);
  
  addChoiceBtn?.addEventListener("click", () => addChoice());

  // Close modals when clicking outside
  [createModal, editModal, deleteModal].forEach(modal => {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        if (modal === createModal) closeCreateModal();
        if (modal === editModal) closeEditModal();
        if (modal === deleteModal) closeDeleteModal();
      }
    });
  });

  // Close modals with Escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (!createModal.classList.contains("hidden")) closeCreateModal();
      if (!editModal.classList.contains("hidden")) closeEditModal();
      if (!deleteModal.classList.contains("hidden")) closeDeleteModal();
    }
  });

  // Show More/Less functionality for choices
  document.addEventListener('DOMContentLoaded', function() {
    // Show More functionality
    document.querySelectorAll('.show-more-btn').forEach(button => {
      button.addEventListener('click', function() {
        const container = this.closest('.choices-container');
        const visibleChoices = container.querySelector('.visible-choices');
        const allChoices = container.querySelector('.all-choices');
        
        visibleChoices.classList.add('hidden');
        allChoices.classList.remove('hidden');
      });
    });

    // Show Less functionality
    document.querySelectorAll('.show-less-btn').forEach(button => {
      button.addEventListener('click', function() {
        const container = this.closest('.choices-container');
        const visibleChoices = container.querySelector('.visible-choices');
        const allChoices = container.querySelector('.all-choices');
        
        allChoices.classList.add('hidden');
        visibleChoices.classList.remove('hidden');
        
        visibleChoices.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    });
  });
</script>

<style>
  .choices-container {
    transition: all 0.3s ease;
  }
  
  .visible-choices, .all-choices {
    transition: opacity 0.3s ease;
  }
  
  .show-more-btn, .show-less-btn {
    transition: all 0.2s ease;
  }
  
  .show-more-btn:hover, .show-less-btn:hover {
    transform: translateY(-1px);
  }
  
  .choice-item {
    transition: all 0.2s ease;
  }
  
  .choice-item:hover {
    border-color: #10420C;
    box-shadow: 0 2px 4px rgba(16, 66, 12, 0.1);
  }
  
  #choicesContainer::-webkit-scrollbar {
    width: 6px;
  }
  
  #choicesContainer::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }
  
  #choicesContainer::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }
  
  #choicesContainer::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
  }
  
  .choice-number {
    min-width: 24px;
    text-align: center;
  }
</style>

{% endblock %}
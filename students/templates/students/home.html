{% extends 'students/base.html' %}

{% block title %}
Home Students
{% endblock  %}

{% block content %}
{% load static %}
<!-- Content -->

<div class="flex-grow flex p-4 md:p-8    h-[800px] ease-in ">

<div class="absolute inset-0 "></div>

<!-- Left Section -->
<div class="flex-1 flex flex-col items-center relative ">
    <p class="font-poppins font-medium text-[24px] leading-[100%] tracking-[0%] text-[#FFCC00]">
        Current Serving
    </p>
    <h2 class="font-medula font-normal text-[120px] leading-[100%] tracking-[0%] text-green-700">
        Token Number
    </h2>
    <div class="mt-9 bg-white shadow-[0.5px_5px_10px_4px_rgba(0,0,0,0.3)] flex flex-col items-center justify-center w-[402px] h-[293px] rounded-[31px] top-[338px] left-[130px]">
            <p id="current" class="font-medula font-normal text-[200px] leading-[100%] tracking-[0%] text-[#10934F]">
                 </p>
      
   
            <p id="user_type" class="font-poppins font-normal text-[22px] leading-[100%] tracking-[0%] text-[#10934F] self-start ml-9">
                Student
            </p>   
    </div>
    <div class="mt-9 flex flex-col items-center justify-center">
    <p class="font-poppins font-normal text-[18px] leading-[100%] tracking-[0%] text-[#10934F]">
        Serving Time
    </p>
    <p class="font-medula font-normal text-[100px] leading-[100%] tracking-[0%] text-[#10934F]">
        00 : 47 : 12
    </p>
    </div>
</div>

<!---------------------------------------------------------------->
        <div class="relative z-10 border-1 border-gray-400 mx-6"></div>

<!-- Right Section -->
<div class="z-10 flex-1 flex  justify-center ">

<!-- Right: Date, Instruction, Buttons -->
<div class="">
    <!-- Date  Time -->
    <div>
        <p class="text-[32px] font-bold leading-none text-[#10934F]" style="font-family: 'Poppins', sans-serif;">
            WEDNESDAY
        </p>
        <p class="text-[32px] leading-none text-[#10934F]" style="font-family: 'Medula One', cursive; font-weight: 400;">
            August 20 2025
        </p>
        <p class="text-[64px] leading-none text-[#FFCC00]" style="font-family: 'Medula One', cursive;">
            9:37 
        <span class="text-[#10934F] text-[30px]">
            AM
        </span>
        </p>

    </div>

    <!-- Instruction -->
    <div class="bg-white shadow-lg rounded p-4 my-4 w-[270px] h-[239px] top-[372px] left-[1143px]">
    <h3 class="font-medula text-[32px] leading-[100%] tracking-[0%] text-[#10934F] text-center">
        Instruction
    </h3>
    <p class="font-poppins mt-3 text-[15px] leading-[100%] text-center text-justify">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
    </p>

    </div>

    <!-- Buttons -->
    <div class="mt-9">
        <button type="button" onclick="openModal()" 
        class="w-[270px] h-[71px] top-[657px] left-[1143px] bg-[#10934F] hover:bg-[#10934F]/80 cursor-pointer text-white shadow-md font-medula text-[32px] leading-[100%] tracking-[0%]">
            Student
        </button>
    </div>
    <div class="mt-9">
        <button type="button" onclick="openGuestModal()"
         class="w-[270px] h-[71px] top-[657px] left-[1143px] bg-[#10934F] hover:bg-[#10934F]/80 cursor-pointer text-white shadow-md font-medula text-[32px] leading-[100%] tracking-[0%]">
            Guest
        </button>
    </div>
</div>
</div>

    <!-- Student Modal -->
    <div id="studentModal" class="fixed inset-0 bg-black/20 backdrop-blur-sm hidden  flex items-center justify-center z-50 ">
        <div class="bg-white shadow-xl w-[450px] h-[546px] max-w-md  py-5 px-12 text-black">
            <!-- Modal Header -->
        
            <p class="inria-sans-regular text-sm text-black text-center">Please enter your  information to login</p>
            <button onclick="closeModal()" class="text-white text-xl">&times;</button>
        
            
            <!-- Modal Form -->
            <form id="studentForm" action="{% url 'student_submit' %}" method="post">
            {% csrf_token %}
            
            <!-- ID Number -->
            <div class="mb-2">
                <label class="block mb-2" for="idNumber">ID Number</label>
                <input type="text" id="idNumber" name="idNumber" required
                    class="w-full p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
            </div>

            <div class="flex flex-row gap-2">
                <!-- First Name -->
                <div class="mb-2">
                    <label class="block mb-2" for="firstName">First Name</label>
                    <input type="text" id="firstName" name="firstName" required
                        class="w-full p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
                </div>

                <!-- Middle Name -->
                <div class="mb-2">
                    <label class="block mb-2" for="middleName">M.I.</label>
                    <input type="text" id="middleName" name="middleName" maxlength="1"
                        class="w-10 p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
                </div>

                <!-- Last Name -->
                <div class="mb-2">
                    <label class="block mb-2" for="lastName">Last Name</label>
                    <input type="text" id="lastName" name="lastName" required
                        class="w-full p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
                </div>
            </div>

            <!-- Course -->
            <div class="mb-2">
                <label class="block mb-2" for="course">Course</label>
                <select id="course" name="course" required
                        class="w-full p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
                    <option value="">Select Course</option>
                    {% for c in courses %}
                    <option value="{{ c.id }}">{{ c.courses }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Request Type -->
            <div class="mb-3">
                <label class="block mb-2" for="request">Request Type</label>
                <select id="request" name="request" required
                        class="w-full p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
                    <option value="">Select Request</option>
                    {% for r in requests %}
                    <option value="{{ r.id }}">{{ r.request }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Priority -->
            <div class="mb-6 flex items-center">
                <input type="checkbox" id="is_priority" name="is_priority"
                    class="mr-2 text-[#10934F] border-gray-300 rounded">
                <label for="is_priority">Priority (PWD/Senior)</label>
            </div>

            <!-- Submit -->
            <div>
                <button type="submit"
                        class="px-4 py-2 bg-[#10934F] w-full text-white hover:bg-[#10934F]/80 cursor-pointer transition">
                    Submit
                </button>
            </div>
        </form>

        </div>
    </div>


    <!-- Guest Modal -->
    <div id="guestModal" class="fixed inset-0 bg-black/20 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white shadow-xl w-[450px] h-[389px] max-w-md py-5 px-12 text-black relative">
            
            <!-- Close Button -->
            <button onclick="closeGuestModal()" 
                class="absolute top-2 right-4 text-3xl font-bold text-[#10934F]">&times;</button>

            <p class="inria-sans-regular text-sm text-black text-center mb-10">
                Please enter your information to make a request
            </p>
            
            <!-- Modal Form -->
            <form id="guestForm" action="{% url 'guest_submit' %}" method="post">
                {% csrf_token %}

                <div class="flex flex-row gap-2">
                    <!-- First Name -->
                    <div class="mb-2 flex-1">
                        <label class="block mb-2" for="guestFirstName">First Name</label>
                        <input type="text" id="guestFirstName" name="firstName" required
                            class="w-full p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
                    </div>

                    <!-- Middle Name -->
                    <div class="mb-2 w-16">
                        <label class="block mb-2" for="guestMiddleName">M.I.</label>
                        <input type="text" id="guestMiddleName" name="middleName" maxlength="1"
                            class="w-full p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
                    </div>

                    <!-- Last Name -->
                    <div class="mb-2 flex-1">
                        <label class="block mb-2" for="guestLastName">Last Name</label>
                        <input type="text" id="guestLastName" name="lastName" required
                            class="w-full p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
                    </div>
                </div>

                <!-- Request Type -->
                <div class="mb-3">
                    <label class="block mb-2" for="guestRequest">Request Type</label>
                    <select id="guestRequest" name="request" required
                            class="w-full p-2 border border-black focus:outline-none focus:ring-2 focus:ring-black">
                        <option value="">Select Request</option>
                        {% for r in requests %}
                        <option value="{{ r.id }}">{{ r.request }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Priority -->
                <div class="mb-6 flex items-center">
                    <input type="checkbox" id="guestPriority" name="is_priority"
                        class="mr-2 text-[#10934F] border-gray-300 rounded">
                    <label for="guestPriority">Priority (PWD/Senior)</label>
                </div>

                <!-- Submit -->
                <div>
                    <button type="submit"
                            class="px-4 py-2 bg-[#10934F] w-full text-white hover:bg-[#10934F]/80 cursor-pointer transition">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>


<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="shadow-[0.5px_5px_10px_4px_rgba(0,0,0,0.4)] rounded-2xl relative custom-bg bg-white flex flex-col"
         style="width:80vw; height:90vh; max-width:1200px;">

        <!-- Close Button -->
        <button onclick="closeSuccessModal()" 
            class="absolute top-[2vh] right-[2vh] font-bold text-gray-500 hover:text-gray-800 cursor-pointer"
            style="font-size:5vh;">&times;</button>

        <!-- Content Scroll Area -->
        <div class="overflow-y-auto px-[4vh] py-[2vh] flex-1">

            <!-- Queue Number Section -->
            <div class="text-center my-[3vh]">
                <h2 class="font-bold text-green-700 mb-[1vh]" style="font-size:4vh;">Your Queue Number</h2>
                <p class="text-gray-600 mb-[2vh] font-semibold" style="font-size:2vh;">
                    Please take a picture of your number so that you won’t forget
                </p>
                <div class="bg-white border-2 border-gray-200 rounded-lg shadow-[0.5px_5px_10px_4px_rgba(0,0,0,0.3)] inline-block px-[4vh] py-[3vh]">
                    <p id="successTicket" class="font-bold text-green-700" style="font-size:12vh; line-height:1;">---</p>
                </div>
                <p class="text-gray-700 mt-[2vh]" style="font-size:1.5vh;">
                    After you take a picture of your Queue Number, your number will be called shortly.
                </p>
            </div>

            <hr class="my-[4vh]">

            <!-- Survey Code Section -->
            <div class="text-center">
                <h2 class="font-bold text-yellow-500 mb-[1vh]" style="font-size:4vh;">
                    Code for the Client Survey Satisfaction
                </h2>
                <p class="text-gray-600 mb-[2vh] font-semibold" style="font-size:2vh;">
                    Please take a picture of your code, you may use this after you are done serving
                </p>
                <div class="bg-white border-2 border-gray-200 rounded-lg shadow-[0.5px_5px_10px_4px_rgba(0,0,0,0.3)] inline-block px-[4vh] py-[3vh]">
                    <p id="successSurvey" class="font-bold text-yellow-500" style="font-size:12vh; line-height:1;">ABC-123</p>
                </div>
                <p class="text-gray-700 mt-[2vh]" style="font-size:1.5vh;">
                    This code is for the Client Satisfaction Survey form for students and guests, designed to improve the quality of service we provide.
                </p>
            </div>
        </div>
    </div>
</div>






<script>
    // ===== Student Modal =====
    function openModal() {
        document.getElementById('studentModal').classList.remove('hidden');
        document.body.style.overflow = "hidden";
    }
    
    function closeModal() {
        document.getElementById('studentModal').classList.add('hidden');
        document.body.style.overflow = "";
    }

    document.getElementById('studentModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    document.getElementById('studentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        const response = await fetch(form.action, { method: "POST", body: formData });
        const data = await response.json();

        if (data.success) {
            showSuccessModal(data.ticket, data.survey_code);
            form.reset();
            closeModal();
        } else {
            alert("Failed to submit form!");
        }
    });

    // ===== Guest Modal =====
    function openGuestModal() {
        document.getElementById('guestModal').classList.remove('hidden');
        document.body.style.overflow = "hidden";
    }

    function closeGuestModal() {
        document.getElementById('guestModal').classList.add('hidden');
        document.body.style.overflow = "";
    }

    document.getElementById('guestModal').addEventListener('click', function(e) {
        if (e.target === this) closeGuestModal();
    });

    document.getElementById('guestForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        const response = await fetch(form.action, { method: "POST", body: formData });
        const data = await response.json();

        if (data.success) {
            showSuccessModal(data.ticket, data.survey_code);
            form.reset();
            closeGuestModal();
        } else {
            alert("Failed to submit guest form!");
        }
    });

    // ===== Shared Success Modal =====
    function showSuccessModal(ticket, surveyCode) {
        document.getElementById("successTicket").textContent = ticket;
        document.getElementById("successSurvey").textContent = surveyCode ?? "N/A"; // guest might not have survey_code
        document.getElementById("successModal").classList.remove("hidden");
        document.body.style.overflow = "hidden";
    }

    function closeSuccessModal() {
        document.getElementById("successModal").classList.add("hidden");
        document.body.style.overflow = "";
        location.reload(); // optional, can remove if you don’t want reload
    }




    const socket = new WebSocket(
        "ws://" + window.location.host + "/ws/students/"
    );

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("Received from server:", data);

        // Show current
        const currentDiv = document.getElementById("current");
        const userType = document.getElementById("user_type");
        // Always show ONLY the current ticket
        if (data.current && data.current.ticket_number) {
            currentDiv.className = "font-medula font-normal text-[200px] leading-[100%] tracking-[0%] text-[#10934F]";
            userType.textContent = data.current.status;
            currentDiv.textContent = data.current.ticket_number;
        } 
        else {
            currentDiv.className = "font-poppins font-normal text-[100px] leading-[100%] tracking-[0%] text-[#10934F]";
            userType.textContent = "";
            currentDiv.textContent = "NONE";
        }

        
    };

    socket.onclose = function(e) {
        console.error("WebSocket closed unexpectedly");
    };
</script>

{% endblock %}